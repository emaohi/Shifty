{% extends 'manager/base.html' %}

{% block title %}
<title>Shifty Bitch</title>
{% endblock %}

{% block comp_name %}
    <b>{{ user.profile.business.business_name }}</b> manager dashboard
{% endblock %}

{% block style %}
<style>
    .btn-xl{
        padding: 10px 20px;
        font-size: 20px;
        border-radius: 10px;
        width:100%;
    }
    .approved{
        background-color: greenyellow !important;
    }
    .rejected{
        background-color: lightcoral !important;
    }
</style>
{% endblock %}

{% block content %}



<div class="container">
  <ul class="nav nav-tabs">
    <li class="active"><a data-toggle="tab" href="#menu2">New Shift</a></li>
    <li><a data-toggle="tab" href="#menu2">Previous Shifts</a></li>
    <li><a data-toggle="tab" href="#menu1">Employees</a></li>
    <li ><a data-toggle="tab" href="#home">Employee Requests</a></li>
  </ul>

  <div class="tab-content">

    <div id="home" class="tab-pane fade ">
        <div class="container" style="margin-top: 20px">
            <h3>Pending requests</h3>
            {% for request in pending_requests %}
                <div class="row" style="margin-top: 20px">
                    <div class="col-xs-8">
                        <div class="panel panel-default">
                          <div class="panel-heading">
                              <h3 class="panel-title" style="display: inline">{{ request.subject }}</h3>
                              <span style="float: right">From: {{ request.get_issuers_string }}</span>
                          </div>
                          <div class="panel-body">
                              {{ request.text }}
                          </div>
                            <div class="panel-footer">
                                <span class="hidden-id" style="visibility: hidden">{{ request.id }}</span>
                                <span class="timestamp"> {{ request.sent_time }} </span>
                                <div style="float: right">
                                    <button type="button" class="btn btn-xs btn-success approve"><span class="glyphicon glyphicon-ok-sign"></span> Approve</button>
                                    <button type="button" class="btn btn-xs btn-danger reject"><span class="glyphicon glyphicon-remove"></span> Reject</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
        <div class="container" style="margin-top: 50px">
            <h3>Done requests</h3>
            {% for request in done_requests %}
                <div class="row" style="margin-top: 20px">
                    <div class="col-xs-8">
                        <div class="panel panel-default">
                            <div class="panel-heading">
                              <h3 class="panel-title" style="display: inline">{{ request.subject }}</h3>
                              <span style="float: right">From: {{ request.get_issuers_string }}</span>
                          </div>
                          <div class="panel-body">
                              {{ request.text }}
                          </div>
                            {% if request.status == 'A' %}
                                <div class="panel-footer approved">
                            {% else %}
                                <div class="panel-footer rejected">
                            {% endif %}
                                <span class="hidden-id" style="visibility: hidden">{{ request.id }}</span>
                                <span class="timestamp"> {{ request.sent_time }} </span>
                                <div style="float: right">
                                    <span>{{ request.get_status_display }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>

    <div id="menu1" class="tab-pane fade">
        <div class="row" style="margin-top: 130px">
            <div class="col-md-6">
                <a href="{% url 'add_employees' %}" class="btn btn-success btn-xl"
                               role="button">Add Employees</a>
            </div>
            <div class="col-md-6">
                <a href="{% url 'manage_employees' %}" class="btn btn-info btn-xl"
                               role="button">Manage Employees</a>
            </div>
        </div>
    </div>

    <div id="menu2" class="tab-pane fade in active">
      <h3>Menu 2</h3>
      <p>Sed ut perspiciatis unde omnis iste natus error sit voluptatem accusantium doloremque laudantium, totam rem aperiam.</p>
    </div>

  </div>
</div>
</div>
{% endblock %}

{% block javascript %}

    <script>
        setTimeout(function(){
          $('.alert-success').hide()
        }, 60000);

        $(document).ready(function() {
            if (location.hash) {
                $("a[href='" + location.hash + "']").tab("show");
            }
            $(document.body).on("click", "a[data-toggle]", function(event) {
                location.hash = this.getAttribute("href");
            });

            $('.approve').click(function () {
                var request_id = $(this).parents('div').siblings("span:first").text();
{#                alert(request_id);#}
                handle_request("A", request_id);
            });
            $('.reject').click(function () {
                var request_id = $(this).parents('div').siblings("span:first").text();
{#                alert(request_id);#}
                handle_request("R", request_id);
            });
        });
        $(window).on("popstate", function() {
            var anchor = location.hash || $("a[data-toggle='tab']").first().attr("href");
            $("a[href='" + anchor + "']").tab("show");
        });

        function handle_request(new_status, request_id) {
            $.ajax({
              url: "{% url 'handle_emp_request' %}",
              type: "post", //send it through get method
              data: {
                emp_request_id: request_id,
                new_status: new_status
              },
              headers: {
                  'X-CSRFToken': '{{ csrf_token }}'
              },
              success: function(response){
                        window.location.reload();
                    }
            });
        }
    </script>

{% endblock %}